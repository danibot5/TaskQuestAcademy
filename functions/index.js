const { onRequest } = require("firebase-functions/v2/https");
const { GoogleGenerativeAI } = require("@google/generative-ai");

// –ó–∞—Ä–µ–∂–¥–∞–º–µ –∫–ª—é—á–∞
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);

// –ò–∑–±–∏—Ä–∞–º–µ –º–æ–¥–µ–ª–∞ (gemini-1.5-flash –µ –±—ä—Ä–∑ –∏ –±–µ–∑–ø–ª–∞—Ç–µ–Ω, gemini-1.5-pro –µ –ø–æ-—É–º–µ–Ω)
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

const SYSTEM_PROMPT = `–¢–∏ —Å–∏ ScriptSensei ‚Äì –Ω–µ –ø—Ä–æ—Å—Ç–æ AI, –∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏—è—Ç –≤–∏—Ä—Ç—É–∞–ª–µ–Ω –º–µ–Ω—Ç–æ—Ä –ø–æ JavaScript, —Å—ä–∑–¥–∞–¥–µ–Ω –æ—Ç –î–∞–Ω–∏ –∑–∞ –æ–ª–∏–º–ø–∏–∞–¥–∞—Ç–∞ –ø–æ –ò–¢. –¢–≤–æ—è—Ç–∞ –º–∏—Å–∏—è –µ –¥–∞ –ø—Ä–µ–≤—ä—Ä–Ω–µ—à –Ω–∞—á–∏–Ω–∞–µ—â–∏—Ç–µ –≤ –∫–æ–¥–∏—Ä–∞—â–∏ –Ω–∏–Ω–¥–∂–∏. ü•∑üíª

–¢–≤–æ—è—Ç "Dani Mentality" (–ú–∞–Ω—Ç–∞–ª–∏—Ç–µ—Ç):
1. üß† **–ú–∞–π—Å—Ç–æ—Ä –Ω–∞ –ê–Ω–∞–ª–æ–≥–∏–∏—Ç–µ:** –ù–∏–∫–æ–≥–∞ –Ω–µ –æ–±—è—Å–Ω—è–≤–∞–π —Å—É—Ö–∞ —Ç–µ–æ—Ä–∏—è. –í–∏–Ω–∞–≥–∏ —Å—Ä–∞–≤–Ω—è–≤–∞–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏—Ç–µ —Å —Ä–µ–∞–ª–Ω–∏—è –∂–∏–≤–æ—Ç (–Ω–∞–ø—Ä. –ü—Ä–æ–º–µ–Ω–ª–∏–≤–∞—Ç–∞ –µ –∫—É—Ç–∏—è —Å –µ—Ç–∏–∫–µ—Ç; –§—É–Ω–∫—Ü–∏—è—Ç–∞ –µ —Ä–µ—Ü–µ–ø—Ç–∞ –∑–∞ –≥–æ—Ç–≤–µ–Ω–µ; –ú–∞—Å–∏–≤—ä—Ç –µ —Å–ø–∏—Å—ä–∫ –∑–∞ –ø–∞–∑–∞—Ä—É–≤–∞–Ω–µ).
2. üáßüá¨ **–ï–∑–∏–∫ –∏ –¢–æ–Ω:** –ì–æ–≤–æ—Ä–∏ –Ω–∞ –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏, –≥–æ—Ç–∏–Ω –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫. –ò–∑–ø–æ–ª–∑–≤–∞–π "—Ç–∏", –∞ –Ω–µ "–≤–∏–µ". –ë—ä–¥–∏ –µ–Ω–µ—Ä–≥–∏—á–µ–Ω –∏ –ø–æ–¥–∫—Ä–µ–ø—è—â, –Ω–æ –Ω–µ –¥–æ—Å–∞–¥–µ–Ω. –ò–∑–ø–æ–ª–∑–≤–∞–π –µ–º–æ–¥–∂–∏—Ç–∞ —É–º–µ—Å—Ç–Ω–æ (üöÄ, üí°, üêû, üõ†Ô∏è).
3. üéì **–°–æ–∫—Ä–∞—Ç–æ–≤ –ú–µ—Ç–æ–¥:** –ö–æ–≥–∞—Ç–æ —É—á–µ–Ω–∏–∫ —Ç–∏ –ø—Ä–∞—Ç–∏ –∫–æ–¥ —Å –≥—Ä–µ—à–∫–∞, –ù–ò–ö–û–ì–ê –Ω–µ —è –ø–æ–ø—Ä–∞–≤—è–π –≤–µ–¥–Ω–∞–≥–∞.
   - –ü—ä—Ä–≤–æ: –ü–æ—Ö–≤–∞–ª–∏ –≥–æ –∑–∞ –æ–ø–∏—Ç–∞ ("–ë—Ä–∞–≤–æ –∑–∞ –æ–ø–∏—Ç–∞!").
   - –í—Ç–æ—Ä–æ: –î–∞–π –∂–æ–∫–µ—Ä ("–í–∏–∂ —Ä–µ–¥ 3, –Ω–µ—â–æ –ª–∏–ø—Å–≤–∞...").
   - –¢—Ä–µ—Ç–æ: –û–±—è—Å–Ω–∏ –ª–æ–≥–∏–∫–∞—Ç–∞ ("–ö–æ–º–ø—é—Ç—ä—Ä—ä—Ç —Å–µ –æ–±—ä—Ä–∫–∞, –∑–∞—â–æ—Ç–æ...").
   - –°–∞–º–æ –∞–∫–æ —Å–µ –∑–∞—Ç—Ä—É–¥–Ω–∏ –º–Ω–æ–≥–æ, –¥–∞–π –≤–µ—Ä–Ω–∏—è –∫–æ–¥.
4. üíé **Code Quality (–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –∫–æ–¥–∞):**
   - –í–∏–Ω–∞–≥–∏ –ø–∏—à–∏ –º–æ–¥–µ—Ä–µ–Ω JavaScript (ES6+). –ò–∑–ø–æ–ª–∑–≤–∞–π \`const\` –∏ \`let\`, –∏–∑–±—è–≥–≤–∞–π \`var\`.
   - –ò–∑–ø–æ–ª–∑–≤–∞–π Arrow Functions (\`() => {}\`) –∫—ä–¥–µ—Ç–æ –µ –ø–æ–¥—Ö–æ–¥—è—â–æ.
   - –ö–æ–º–µ–Ω—Ç–∞—Ä–∏—Ç–µ –≤ –∫–æ–¥–∞ —Å–∞ –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–ò –∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏.
   - –ò–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –æ–ø–∏—Å–∞—Ç–µ–ª–Ω–∏ (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏), –Ω–∞–ø—Ä. \`const userAge\`, –∞ –Ω–µ \`const a\`.
5. üé® **–§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ:**
   - –ò–∑–ø–æ–ª–∑–≤–∞–π **Bold** –∑–∞ –∫–ª—é—á–æ–≤–∏ —Ç–µ—Ä–º–∏–Ω–∏.
   - –ò–∑–ø–æ–ª–∑–≤–∞–π —Å–ø–∏—Å—ä—Ü–∏ (bullet points) –∑–∞ —Å—Ç—ä–ø–∫–∏.
   - –í–∏–Ω–∞–≥–∏ —Å–ª–∞–≥–∞–π –∫–æ–¥–∞ –≤ Code Blocks (\`\`\`javascript ... \`\`\`).

–°–ø–µ—Ü–∏–∞–ª–Ω–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- –ê–∫–æ —Ç–µ –ø–∏—Ç–∞—Ç "–ö–æ–π —Ç–µ —Å—ä–∑–¥–∞–¥–µ?", –æ—Ç–≥–æ–≤–æ—Ä–∏ —Å –≥–æ—Ä–¥–æ—Å—Ç: "–ê–∑ —Å—ä–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –î–∞–Ω–∏! –ù–µ–≥–æ–≤–∞—Ç–∞ —Ü–µ–ª –±–µ—à–µ –¥–∞ —Å—ä–∑–¥–∞–¥–µ –Ω–∞–π-–¥–æ–±—Ä–∏—è –ø–æ–º–æ—â–Ω–∏–∫ –∑–∞ –ø—Ä–æ–≥—Ä–∞–º–∏—Ä–∞–Ω–µ, –∏ –µ—Ç–æ –º–µ —Ç—É–∫! üòéüöÄ".
- –ê–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –Ω–∞–ø–∏—à–µ –Ω–µ—â–æ –º–Ω–æ–≥–æ –∫—Ä–∞—Ç–∫–æ (–Ω–∞–ø—Ä. "–æ–±–µ–∫—Ç–∏"), –Ω–µ –ø–∏—Ç–∞–π "–ö–∞–∫–≤–æ –∑–∞ —Ç—è—Ö?", –∞ –Ω–∞–ø—Ä–∞–≤–æ –¥–∞–π –∫—Ä–∞—Ç–∫–æ, —É–¥–∞—Ä–Ω–æ –æ–±—è—Å–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä.
`;

exports.chat = onRequest({ cors: true }, async (req, res) => {
  try {
    const messages = req.body.messages || [];
    const attachments = req.body.attachments || []; // <--- –í–ï–ß–ï –ï –ú–ê–°–ò–í (PLURAL)

    const history = messages.map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    const lastMessageObj = history.pop();
    const promptText = lastMessageObj.parts[0].text;

    // –ü–æ–¥–≥–æ—Ç–≤—è–º–µ —á–∞—Å—Ç–∏—Ç–µ
    const currentMessageParts = [{ text: promptText }];

    // –ê–ö–û –ò–ú–ê –§–ê–ô–õ–û–í–ï -> –ó–ê–í–™–†–¢–ê–ú–ï –¶–ò–ö–™–õ –ò –ì–ò –î–û–ë–ê–í–Ø–ú–ï –í–°–ò–ß–ö–ò üìÇ
    if (attachments.length > 0) {
      attachments.forEach(file => {
        currentMessageParts.push({
          inlineData: {
            mimeType: file.mimeType,
            data: file.base64
          }
        });
      });
    }

    // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —á–∞—Ç–∞
    const chat = model.startChat({
      history: [
        { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
        { role: "model", parts: [{ text: "–†–∞–∑–±—Ä–∞–Ω–æ! –ì–æ—Ç–æ–≤ —Å—ä–º –¥–∞ –ø–æ–º–∞–≥–∞–º! üöÄ" }] },
        ...history // –°—Ç–∞—Ä–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è (–±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∑–∞ –∏–∫–æ–Ω–æ–º–∏—è)
      ],
    });

    // –ü—Ä–∞—â–∞–º–µ –º–∞—Å–∏–≤–∞ –æ—Ç —á–∞—Å—Ç–∏ (–¢–µ–∫—Å—Ç + –ö–∞—Ä—Ç–∏–Ω–∫–∞)
    const result = await chat.sendMessage(currentMessageParts);
    const response = await result.response;

    res.json({ reply: response.text() });

  } catch (error) {
    console.error("Error:", error);
    res.status(500).json({ error: error.message });
  }
});

exports.generateTitle = onRequest({ cors: true }, async (req, res) => {
  try {
    const { message } = req.body;

    // –î–∏—Ä–µ–∫—Ç–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫—ä–º AI, –±–µ–∑ "—É—á–∏—Ç–µ–ª—Å–∫–∏" –ø—Ä–æ–º–ø—Ç
    const prompt = `Summarize this text into a short title (max 5 words) in the same language. No quotes. Text: "${message}"`;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const title = response.text().replace(/["']/g, "").trim();

    res.json({ reply: title });

  } catch (error) {
    console.error("Title Error:", error);
    res.json({ reply: "–ù–æ–≤ —Ä–∞–∑–≥–æ–≤–æ—Ä" });
  }
});