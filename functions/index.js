const { onRequest } = require("firebase-functions/v2/https");
const { GoogleGenerativeAI } = require("@google/generative-ai");

// –ó–∞—Ä–µ–∂–¥–∞–º–µ –∫–ª—é—á–∞
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);

// –ò–∑–±–∏—Ä–∞–º–µ –º–æ–¥–µ–ª–∞ (gemini-1.5-flash –µ –±—ä—Ä–∑ –∏ –±–µ–∑–ø–ª–∞—Ç–µ–Ω, gemini-1.5-pro –µ –ø–æ-—É–º–µ–Ω)
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

const SYSTEM_PROMPT = `–¢–∏ —Å–∏ ScriptSensei - –Ω–∞–π-–¥–æ–±—Ä–∏—è—Ç –≤–∏—Ä—Ç—É–∞–ª–µ–Ω –º–µ–Ω—Ç–æ—Ä –ø–æ JavaScript –∑–∞ —É—á–µ–Ω–∏—Ü–∏.

–¢–≤–æ–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞:
1. üáßüá¨ –ì–æ–≤–æ—Ä–∏ –≤–∏–Ω–∞–≥–∏ –Ω–∞ –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫.
2. üéì –û–±—è—Å–Ω—è–≤–∞–π –∫–∞—Ç–æ –∑–∞ –Ω–∞—á–∏–Ω–∞–µ—â, –Ω–æ –Ω–µ –∫–∞—Ç–æ –∑–∞ –º–∞–ª–∫–æ –¥–µ—Ç–µ. –ò–∑–ø–æ–ª–∑–≤–∞–π –∞–Ω–∞–ª–æ–≥–∏–∏ –æ—Ç —Ä–µ–∞–ª–Ω–∏—è –∂–∏–≤–æ—Ç.
3. üíª –ö–æ–≥–∞—Ç–æ –ø–∏—à–µ—à –∫–æ–¥, –≤–∏–Ω–∞–≥–∏ –≥–æ –∫–æ–º–µ–Ω—Ç–∏—Ä–∞–π –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏, –Ω–æ –Ω–µ–∫–∞ –∫–æ–¥—ä—Ç –¥–∞ –±—ä–¥–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –µ–∑–∏–∫.
4. üöÄ –ë—ä–¥–∏ –µ–Ω—Ç—É—Å–∏–∞–∑–∏—Ä–∞–Ω! –ò–∑–ø–æ–ª–∑–≤–∞–π –µ–º–æ–¥–∂–∏—Ç–∞, –∑–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—à —É—á–µ–Ω–µ—Ç–æ –∑–∞–±–∞–≤–Ω–æ.
5. üß© –ê–∫–æ —É—á–µ–Ω–∏–∫ —Ç–∏ –ø—Ä–∞—Ç–∏ –∫–æ–¥ —Å –≥—Ä–µ—à–∫–∞, –Ω–µ –º—É –¥–∞–≤–∞–π –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä. –û–±—è—Å–Ω–∏ –º—É –∫—ä–¥–µ –µ –≥—Ä–µ—à–∫–∞—Ç–∞ –∏ –∫–∞–∫ –¥–∞ —è –ø–æ–ø—Ä–∞–≤–∏.

–ê–∫–æ —Ç–µ –ø–∏—Ç–∞—Ç –∫–æ–π —Ç–µ –µ —Å—ä–∑–¥–∞–ª, –∫–∞–∂–∏ –≥–æ—Ä–¥–æ: "–ê–∑ —Å—ä–º —Å—ä–∑–¥–∞–¥–µ–Ω –æ—Ç –î–∞–Ω–∏, –∫–∞—Ç–æ —á–∞—Å—Ç –æ—Ç –Ω–µ–≥–æ–≤–∏—è –ø—Ä–æ–µ–∫—Ç –∑–∞ –æ–ª–∏–º–ø–∏–∞–¥–∞—Ç–∞ –ø–æ –ò–¢!"
`;

exports.chat = onRequest({ cors: true }, async (req, res) => {
  try {
    const messages = req.body.messages || [];

    // Google –∏—Å–∫–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –≤ –º–∞–ª–∫–æ –ø–æ-—Ä–∞–∑–ª–∏—á–µ–Ω —Ñ–æ—Ä–º–∞—Ç
    // –ü—Ä–µ–≤—Ä—ä—â–∞–º–µ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞ OpenAI (user/assistant) –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞ Google (user/model)
    const history = messages.map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }]
    }));

    // –í–∑–∏–º–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ (—Ç–æ–≤–∞, –∫–æ–µ—Ç–æ –ø–∏—Ç–∞—à —Å–µ–≥–∞)
    const lastMessage = history.pop();
    const prompt = lastMessage.parts[0].text;

    // –°—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —á–∞—Ç —Å–µ—Å–∏—è —Å –∏—Å—Ç–æ—Ä–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    const chat = model.startChat({
      history: [
        {
          role: "user",
          parts: [{ text: SYSTEM_PROMPT }],
        },
        {
          role: "model",
          parts: [{ text: "–†–∞–∑–±—Ä–∞–Ω–æ! –ì–æ—Ç–æ–≤ —Å—ä–º –¥–∞ –ø–æ–º–∞–≥–∞–º –Ω–∞ –î–∞–Ω–∏ —Å JavaScript! üöÄ" }]
        },
        ...history
      ],
    });

    // –ü—Ä–∞—â–∞–º–µ –≤—ä–ø—Ä–æ—Å–∞
    const result = await chat.sendMessage(prompt);
    const response = await result.response;
    const text = response.text();

    res.json({ reply: text });

  } catch (error) {
    console.error("Error with Gemini:", error);
    res.status(500).json({ error: "–ì—Ä–µ—à–∫–∞ –≤ AI –º–æ–¥—É–ª–∞: " + error.message });
  }
});