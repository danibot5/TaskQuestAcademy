const { onRequest } = require("firebase-functions/v2/https");
const { OpenAI } = require("openai");
require("dotenv").config();

const SYSTEM_PROMPT = `–¢–∏ —Å–∏ ScriptSensei - –Ω–∞–π-–¥–æ–±—Ä–∏—è—Ç –≤–∏—Ä—Ç—É–∞–ª–µ–Ω –º–µ–Ω—Ç–æ—Ä –ø–æ JavaScript –∑–∞ —É—á–µ–Ω–∏—Ü–∏.

–¢–≤–æ–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞:
1. üáßüá¨ –ì–æ–≤–æ—Ä–∏ –≤–∏–Ω–∞–≥–∏ –Ω–∞ –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫.
2. üéì –û–±—è—Å–Ω—è–≤–∞–π –∫–∞—Ç–æ –∑–∞ –Ω–∞—á–∏–Ω–∞–µ—â, –Ω–æ –Ω–µ –∫–∞—Ç–æ –∑–∞ –º–∞–ª–∫–æ –¥–µ—Ç–µ. –ò–∑–ø–æ–ª–∑–≤–∞–π –∞–Ω–∞–ª–æ–≥–∏–∏ –æ—Ç —Ä–µ–∞–ª–Ω–∏—è –∂–∏–≤–æ—Ç.
3. üíª –ö–æ–≥–∞—Ç–æ –ø–∏—à–µ—à –∫–æ–¥, –≤–∏–Ω–∞–≥–∏ –≥–æ –∫–æ–º–µ–Ω—Ç–∏—Ä–∞–π –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏, –Ω–æ –Ω–µ–∫–∞ –∫–æ–¥—ä—Ç –¥–∞ –±—ä–¥–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –µ–∑–∏–∫.
4. üöÄ –ë—ä–¥–∏ –µ–Ω—Ç—É—Å–∏–∞–∑–∏—Ä–∞–Ω! –ò–∑–ø–æ–ª–∑–≤–∞–π –µ–º–æ–¥–∂–∏—Ç–∞, –∑–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—à —É—á–µ–Ω–µ—Ç–æ –∑–∞–±–∞–≤–Ω–æ.
5. üß© –ê–∫–æ —É—á–µ–Ω–∏–∫ —Ç–∏ –ø—Ä–∞—Ç–∏ –∫–æ–¥ —Å –≥—Ä–µ—à–∫–∞, –Ω–µ –º—É –¥–∞–≤–∞–π –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä. –û–±—è—Å–Ω–∏ –º—É –∫—ä–¥–µ –µ –≥—Ä–µ—à–∫–∞—Ç–∞ –∏ –∫–∞–∫ –¥–∞ —è –ø–æ–ø—Ä–∞–≤–∏.

–ê–∫–æ —Ç–µ –ø–∏—Ç–∞—Ç –∫–æ–π —Ç–µ –µ —Å—ä–∑–¥–∞–ª, –∫–∞–∂–∏ –≥–æ—Ä–¥–æ: "–ê–∑ —Å—ä–º —Å—ä–∑–¥–∞–¥–µ–Ω –æ—Ç –î–∞–Ω–∏, –∫–∞—Ç–æ —á–∞—Å—Ç –æ—Ç –Ω–µ–≥–æ–≤–∏—è –ø—Ä–æ–µ–∫—Ç –∑–∞ –æ–ª–∏–º–ø–∏–∞–¥–∞—Ç–∞ –ø–æ –ò–¢!"
`;

exports.chat = onRequest({ cors: true }, async function (req, res) {
  try {
    if (!process.env.OPENAI_API_KEY) {
      throw new Error("–õ–∏–ø—Å–≤–∞ API –∫–ª—é—á –≤ .env —Ñ–∞–π–ª–∞!");
    }

    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      baseURL: "https://api.groq.com/openai/v1"
    });

    // –¢–£–ö –ï –ü–†–û–ú–Ø–ù–ê–¢–ê: –í–µ—á–µ –æ—á–∞–∫–≤–∞–º–µ —Ü—è–ª–∞ –∏—Å—Ç–æ—Ä–∏—è (–º–∞—Å–∏–≤), –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
    const conversationHistory = req.body.messages || [];

    const completion = await openai.chat.completions.create({
      model: "llama-3.3-70b-versatile",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        ...conversationHistory // –†–∞–∑–ø–∞–∫–µ—Ç–∏—Ä–∞–º–µ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è —Ç—É–∫
      ],
    });

    res.json({ reply: completion.choices[0].message.content });

  } catch (error) {
    console.error("–ì—Ä–µ—à–∫–∞:", error);
    res.json({ error: "–ì—Ä–µ—à–∫–∞: " + error.message });
  }
});